# 🧪 测试方法指南

本项目暂未提供完整自动化测试套件，但推荐基于以下策略循序完善。目标是确保核心模块（Agent、Memory、RAG、Tools、Context）在迭代中保持稳定。

---

## 1. 测试金字塔

```
    /\
   /E2E\      ← 用例少，覆盖关键用户旅程
  /____\
 /Integr\     ← 关注模块协作（Agent × Memory/RAG/Tools）
/______\
/  Unit  \    ← 覆盖率最高，定位问题最快
\________/
```

| 层级 | 关注点 | 建议工具 | 示例 |
| --- | --- | --- | --- |
| 单元测试 | 函数/类行为、异常分支 | `pytest` | `MemorySystem.retrieve` 返回排序正确 |
| 集成测试 | 模块间交互/数据流 | `pytest` + 假数据 | Agent 处理消息时同时命中记忆 + 工具 |
| 端到端 | 核心业务路径 | CLI 脚本 / Playwright | “安装 → 初始化 → 处理请求” 全流程 |

---

## 2. 覆盖范围规划

| 模块 | 建议用例 | 特别注意 |
| --- | --- | --- |
| `MemorySystem` | 添加/检索/更新/清理 | 超过容量、重要性衰减、并发访问 |
| `RAGSystem` | 添加/检索/删除文档 | 空查询、低相关度、批量导入 |
| `ToolSystem` | 注册函数、参数校验、异常工具 | 事件循环存在时的调用、健康检查 |
| `ContextManager` | 摘要、意图、实体提取 | 长对话截断、意图为 `unknown` 的兜底 |
| `IntelligentAgent` | 正常流程、工具失败、记忆缺失 | 状态迁移、响应里的置信度/来源信息 |

---

## 3. 编写测试示例

### 3.1 单元测试·工具调用
```python
import pytest
from src.utils.tools import ToolSystem

@pytest.mark.asyncio
async def test_register_and_call_callable_tool():
    async def echo(text: str) -> str:
        return text

    tools = ToolSystem()
    await tools.register_callable("echo", echo, schema={...})

    result = await tools.call_tool_async("echo", {"text": "hello"})
    assert result.success
    assert result.result == "hello"
```

### 3.2 集成测试·Agent 处理消息
```python
@pytest.mark.asyncio
async def test_agent_process_message_with_memory(tmp_path):
    from src.agents.agent import IntelligentAgent

    agent = IntelligentAgent()
    await agent.process_message("记住：总部在北京")
    response = await agent.process_message("总部在哪？")

    assert "北京" in response.content
    assert response.retrieved_memories
```

### 3.3 端到端脚本
```bash
python examples/quickstart.py  # 观察日志输出是否符合预期
```

---

## 4. 测试数据与环境

- **数据**：优先使用轻量、可重复的内存数据；需要外部服务时，使用 mock/server 或假数据。
- **环境**：
  - 本地开发：虚拟环境 + `requirements.txt`
  - CI/容器：补充 `requirements-dev.txt` 后可运行 `pytest`
- **并发**：涉及异步调用时，使用 `pytest-asyncio` 或 `anyio` 进行协程测试。

---

## 5. 自动化建议

| 任务 | 触发时机 | 命令 |
| --- | --- | --- |
| 单元测试 | 提交前 | `pytest tests/unit -q` |
| 集成测试 | 合并前 / nightly | `pytest tests/integration -q` |
| 语法检查 | 可选 | `flake8 src/`、`mypy src/` |
| 示例验证 | 发布前 | `python examples/quickstart.py` |

> 暂无官方 CI 脚本，可根据团队需要在 GitHub Actions 或其他平台编排上述命令。

---

## 6. 质量门槛（参考值）

| 指标 | 目标 |
| --- | --- |
| 单元测试覆盖率 | ≥ 80% |
| 集成用例通过率 | 100% |
| 端到端路径 | 至少 1 条成功运行 |
| 工具调用错误率 | < 1%（异常需记录日志） |

若暂时无法达到目标，务必在 PR 中说明原因与后续计划。

---

## 7. 常见问题

- **`pytest` 找不到命令**：确认已安装 `requirements-dev.txt`。
- **Async 测试失败**：记得添加 `@pytest.mark.asyncio` 或使用 `pytest-asyncio` 插件。
- **网络依赖不稳定**：使用 mock 或注入假实现，保证测试可重复。
- **Token/配置泄露**：不要在测试中硬编码敏感信息，使用环境变量或 mock。

---

如在实践中发现更高效的测试套路，欢迎在 `guides/05-综合总结.md` 中补充或发起 PR。
