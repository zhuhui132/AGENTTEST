# 💻 技术实现指南

本文介绍 AgentTest 核心模块的设计要点与常见扩展方式，方便在调试或二次开发时快速定位代码位置。

---

## 1. 总体结构

```
src/
├── agents/agent.py        # IntelligentAgent + 同步 Agent 包装器
├── memory/memory.py       # MemorySystem：内存持久 + 评分策略
├── rag/rag.py             # RAGSystem：文档存储与检索
├── utils/tools.py         # ToolSystem：工具注册/执行
├── utils/context.py       # ContextManager：摘要、实体、意图
├── core/                  # 类型、接口、异常、配置
└── llm/base.py            # LLM 抽象及增强实现
```

### 交互流程
1. `IntelligentAgent.process_message` 接收消息，校验并写入历史
2. 构造上下文（`ContextManager.build_context`）
3. 并发检索记忆 + 文档（`MemorySystem.retrieve` / `RAGSystem.retrieve`）
4. 规划工具调用 → `ToolSystem.call_tool_async`
5. `_compose_response` 汇总所有信息生成输出

---

## 2. 核心模块拆解

### 2.1 IntelligentAgent
- **状态流转**：初始化 → `IDLE` → `PROCESSING` → `IDLE/ERROR/SHUTDOWN`
- **同步包装**：`Agent.process_message` 通过 `asyncio.run` 封装，便于在 CLI 使用
- **可扩展点**：
  - `_plan_tool_usage`：按关键词或外部策略决定调用哪些工具
  - `_generate_suggestion`：自定义响应内容
  - 依赖注入：`memory_system`、`rag_system`、`tools`、`context_manager`

### 2.2 MemorySystem
- **数据结构**：`MemoryItem` 包含 id、内容、重要性、访问时间、标签等
- **检索逻辑**：相关度（字符串包含） × 时间衰减 × 重要性 → 排序
- **扩展**：实现 `BaseMemory` 接口即可替换，如接入 Redis/向量库
- **维护**：`cleanup` 按配置清理过期或低重要性的记忆

### 2.3 RAGSystem
- **用途**：内存型文档存储，适合快速原型与测试
- **检索**：简单的全文包含 + 文档长度排序，可替换为向量检索
- **扩展建议**：
  - 替换 `_similarity` 函数，引入余弦/向量数据库
  - 实现 `_evict_documents` 自动淘汰旧文档

### 2.4 ToolSystem
- **注册方式**：
  - `register_tool`（BaseTool 子类）
  - `register_callable`（自动包装普通函数）
- **调用限制**：同步场景请直接调用 `call_tool_async`；`call_tool` 若检测到已有事件循环会抛出错误，提示改用异步
- **默认工具**：项目启动时注册了一个“calculator”示例

### 2.5 ContextManager
- **上下文窗口**：保留最近 `max_history` 条消息，避免 token 爆炸
- **摘要**：拼接最近对话的“角色 + 文本片段”
- **意图/实体识别**：基于关键词的轻量实现，可替换为更准确的 NLP 模型
- **清理**：`cleanup_contexts` 按超时时间移除旧会话

### 2.6 LLM 抽象
- `BaseLLM`：统一生成、流式生成、嵌入与 token 计数接口
- `LLMWithTools`：先解析工具需求再生成回答
- `RateLimitedLLM`：包裹基础模型，限制每分钟调用次数

---

## 3. 常见扩展示例

| 目标 | 建议入口 | 提示 |
| --- | --- | --- |
| 自定义记忆持久化 | 实现 `BaseMemory` → 注入 `IntelligentAgent(memory_system=...)` | 可使用 Redis、SQLite、向量库 |
| 接入外部 RAG | 在 `RAGSystem` 中替换检索实现 | 保留相同接口，便于 Agent 复用 |
| 扩展工具 | `ToolSystem.register_callable` | 确保 `schema` 中的参数描述清晰 |
| 自定义上下文策略 | 继承 `ContextManager` | 可加入摘要模型、意图识别模型 |
| 新增配置 | `config/` + `ConfigManager.save_config` | 更新文档并说明默认值 |

---

## 4. 依赖与环境

- **运行时**：Python 3.10+（已使用 `typing.Annotated`、`asyncio` 新特性）
- **可选依赖**：`redis`、`httpx` 等根据实际扩展需求添加
- **示例脚本**：`examples/quickstart.py` 展示最小使用流程

---

## 5. 调试 Tips

1. **充分利用日志**：`logging.getLogger(__name__)` 已在各模块定义，调整 `LOG_LEVEL` 可观察执行细节
2. **异步问题排查**：若出现 “event loop is closed” 或 “already running” 错误，确认同步代码中未重复调用 `asyncio.run`
3. **工具失败兜底**：`ToolResult.success=False` 时会写入响应，可在 `_compose_response` 中自定义处理
4. **文档更新**：新增模块后别忘了修改 `docs/` 对应章节及 `README` 导航

---

如需编写更深入的教程或分享经验，欢迎在 `docs/guides/05-综合总结.md` 中补充。
