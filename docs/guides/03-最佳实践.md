# 🏆 开发与协作最佳实践

面向日常开发者与维护者，提供一套轻量可执行的原则，确保 AgentTest 在不断演进时保持高质量与可维护性。

---

## 1. 代码组织

1. **模块职责清晰**
   - `agents/`：仅负责消息编排，避免塞入业务逻辑
   - `memory/`、`rag/`、`utils/tools.py`：各自处理数据存储、检索与工具
   - 公共类型/异常使用 `src/core/*`

2. **保持异步链路纯净**
   - 异步函数尽量 `await`，不要在内部调用 `asyncio.run`
   - 同步场景通过顶层 `Agent` 包装器处理

3. **导出入口明确**
   - 新增公共能力时更新 `src/__init__.py` 及对应模块的 `__all__`
   - 示例代码放入 `examples/`，便于回归测试

---

## 2. 代码风格

- 遵循 `PEP8`，缩进 4 空格，文件编码 UTF-8
- 注释使用中文，必要时保留关键英文术语
- 函数长度尽量 < 80 行；超过时考虑拆分
- 日志使用 `logging`，避免 `print`
- 对外错误使用自定义异常（如 `MemoryError`、`ToolError`）

---

## 3. 文档同步

| 动作 | 需要更新 |
| --- | --- |
| 新增/修改功能 | 对应子目录文档 + `docs/README.md` 导航 |
| 新增配置/环境变量 | `docs/guides/04-技术实现指南.md` 或 `config/` 说明 |
| 重要变更或计划 | `docs/guides/05-综合总结.md` |

> 建议在 PR 模板中加入“文档是否已更新”选项，避免遗漏。

---

## 4. 提交习惯

1. **Step Commit**：一次提交聚焦一种变更（功能/修复/文档）
2. **覆盖自测**：至少运行 `python examples/quickstart.py`，关键模块需增加单测
3. **提交信息格式**：`type(scope): description`
   - 示例：`feat(memory): support redis backend`
   - 常用 type：`feat` / `fix` / `docs` / `test` / `refactor`

---

## 5. 常见问题快速检查

| 现象 | 排查路线 |
| --- | --- |
| Agent 响应为空 | 检查工具执行结果；确认 `_compose_response` 是否拼接内容 |
| 记忆不生效 | 确认 `add_memory` 是否被调用；检索关键词大小写是否匹配 |
| 事件循环冲突 | 同步代码里误用 `asyncio.run`；请改用 `await` 或 `run_until_complete` 包装 |
| 文档链接 404 | 更新 `docs/README.md` 和相对路径；使用 `./子目录/文件.md` 格式 |

---

## 6. 评审清单

- [ ] 核心逻辑是否有单测或示例
- [ ] 工具/记忆/RAG 是否考虑异常路径
- [ ] 日志与错误信息能否帮助定位问题
- [ ] 文档/README 是否同步
- [ ] 新依赖是否写入 `requirements*.txt`

---

## 7. 推荐工具链

| 分类 | 工具 | 用法 |
| --- | --- | --- |
| 格式化 | `black` | `black src/ tests/` |
| 静态检查 | `flake8` / `mypy` | `flake8 src/`、`mypy src/` |
| 单元测试 | `pytest` | `pytest tests/unit -q` |
| 异步测试 | `pytest-asyncio` | 为协程测试加上 `@pytest.mark.asyncio` |

---

保持“简洁、可读、可扩展”的原则，能极大降低后续维护成本。若有新的实践经验，欢迎补充到本文件。
